CKEDITOR.plugins.add("ibmbinaryimagehandler",{lang:"ar,ca,cs,da,de,el,en,es,fi,fr,he,hr,hu,it,iw,ja,kk,ko,nb,nl,no,pl,pt,pt-br,ro,ru,sk,sl,sv,th,tr,uk,zh,zh-cn,zh-tw",init:function(c){var p=/<img[^>]*>/i;if((/\S/.test(c.config.ibmBinaryImageUploadUrl)||c.config.ibmPublishBinaryData)&&!c.config.ibmFilterPastedDataUriImage){var j=document.createElement("iframe");j.style.display="none";document.body.appendChild(j);var k=function(a){if(a.type.match("image.*")){var b=new FileReader;b.onload=function(){_html=
b.result;null!=_html&&c.fire("paste",{size:a.size,type:a.type,name:a.name,dataValue:'<img src="'+_html+'">'})};b.readAsDataURL(a)}},q=CKEDITOR.tools.addFunction(function(a){if(a){for(var b=0;b<a.length;b++){var d=a[b].lastIndexOf("/"),f=a[b].lastIndexOf("."),d=a[b].substring(d+1,f);if(d=c.document.getById(d))d.setAttribute("src",a[b]),d.setAttribute("data-cke-saved-src",a[b])}c.fire("updateSnapshot")}},this),r=CKEDITOR.tools.addFunction(function(a){if(a){for(var b=0;b<a.length;b++){var d=a[b],f=d.url;
if(d=c.document.getById(d.id))d.setAttribute("src",f),d.setAttribute("data-cke-saved-src",f)}c.fire("updateSnapshot")}},this),n=CKEDITOR.tools.addFunction(function(a){if(a){for(var b=0;b<a.length;b++){var d=c.document.getById(a[b]);d&&d.remove()}c.fire("updateSnapshot")}},this);c.on("destroy",function(){document.body.removeChild(j)});c.on("paste",function(a){var b=/<img[^>]+src=["']{1}(data:image\/(?:(?!["'])[\w\W])*)["']{1}[^>]*[\/]?>/gi,d=/src=["']data:image\/[^('|")]*["']/i,f=a.data.dataValue,
s=CKEDITOR.env.ie?j.contentWindow.document:j.contentDocument;if(b.test(f)){var k=(new Date).getTime();if(c.config.ibmBinaryImageUploadUrl){var g=document.createElement("form");g.enctype="multipart/form-data";g.method="POST";var e={};e.CKEditor=c.name;e.CKEditorFuncNum=q;e.CKEditorDeleteFuncNum=n;e.Timestamp=k;var m=g;var h=c.config.ibmBinaryImageUploadUrl,l=[];if(e){for(var o in e)l.push(o+"="+encodeURIComponent(e[o]));e=h+(-1!=h.indexOf("?")?"&":"?")+l.join("&")}else e=h;m.action=e}b=f.match(b);
m=[];for(e=0;e<b.length;e++){h=k+"_"+e;l=b[e].match(d);f=f.replace(b[e],b[e].replace("<img",'<img id="'+h+'"'));if(c.config.ibmPublishBinaryData){var i={};i.data=l;if(a.data.name&&(i.name=a.data.name,a.data.size&&(i.size=a.data.size),a.data.type))i.type=a.data.type;i.id=h}else g.innerHTML+='<input type="text" name="imageUri'+e+'" value='+l+">";m.push(i)}c.config.ibmPublishBinaryData?c.config.ibmPublishBinaryData(r,n,c.name,m):(s.body.appendChild(g),g.submit());a.data.dataValue=f}});c.on("contentDom",
function(a){if(CKEDITOR.env.webkit)c.document.on("paste",function(b){var d=b.data.$.clipboardData.items;if(d)for(var a=0;a<d.length;a++)if(-1!==d[a].type.indexOf("image")){var c=d[a].getAsFile();b.data.$.preventDefault();k(c)}});a.editor.document.on("drop",function(b){var a=CKEDITOR.env.ie?"url":"text/html",a=CKEDITOR.env.ie?'<img src="'+b.data.$.dataTransfer.getData(a)+'">':b.data.$.dataTransfer.getData(a);CKEDITOR.env.mac&&(a=/\S/.test(b.data.$.dataTransfer.getData("url"))?'<img src="'+b.data.$.dataTransfer.getData("url")+
'">':b.data.$.dataTransfer.getData("text/html"));var f=/<img[^>]+src=["']{1}(data:image\/(?:(?!["'])[\w\W])*)["']{1}[^>]*[\/]?>/gi;if(p.test(a)&&f.test(a))b.data.$.preventDefault(),c.fire("paste",{dataValue:a});else if(0<b.data.$.dataTransfer.files.length){b.data.$.preventDefault();b=b.data.$.dataTransfer.files;for(a=0;a<b.length;a++)b[a].type.match("image.*")&&k(b[a])}})})}}});
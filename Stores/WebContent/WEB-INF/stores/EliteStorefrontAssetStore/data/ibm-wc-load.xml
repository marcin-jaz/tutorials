<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data-deploy SYSTEM "ibm-wc-load.dtd">
<data-deploy base-dir="." default-target="all">
	<asset id="profileorg" location="profileorg.xml"/>
	<asset id="master" location="store-data-assets.xml"/>
	<asset id="resolved.master" location="store-data-assets.resolved.xml"/>
	<asset id="foreignKeys" location="ForeignKeys.dtd" type="dtd"/>
	<asset id="strutsConfigUpdate.template" location="struts-config-update-common.tpl.xml"/>
	<asset id="strutsConfigUpdate" location="struts-config-update-common.xml"/>
	<asset id="b2b-strutsConfigUpdate.template" location="struts-config-update-b2b.tpl.xml"/>
	<asset id="b2b-strutsConfigUpdate" location="struts-config-update-b2b.xml"/>
	<asset id="strutsTileConfigUpdate.template" location="tiles-defs-update.tpl.xml"/>
	<asset id="strutsTileConfigUpdate" location="tiles-defs-update.xml"/>
	<asset id="account" location="baseaccount.xml"/>
	<asset id="." location=""/>

	<deploy-task-cmd name="accountImport" class="com.ibm.commerce.tools.devtools.publish.tasks.trading.AccountImportTaskCmd"/>
	<deploy-task-cmd name="commandInvoker" class="com.ibm.commerce.tools.devtools.publish.tasks.CommandInvokerTaskCmd"/>
	<deploy-task-cmd name="reconcileStoreLanguages" class="com.ibm.commerce.tools.devtools.publish.tasks.languages.ReconcileLanguagesTaskCmd"/>
	<deploy-task-cmd name="copyLocaleFile" class="com.ibm.commerce.tools.devtools.publish.tasks.unpack.CopyLocaleFileTaskCmd"/>
	<deploy-task-cmd name="copyATPFiles" class="com.ibm.commerce.tools.devtools.publish.tasks.unpack.CopyTaskCmd"/>
	<deploy-task-cmd name="setupContentDirectory" class="com.ibm.commerce.tools.devtools.publish.tasks.catalog.SetupContentManagedDirectoryTaskCmd"/>
	<deploy-task-cmd name="findStore" class="com.ibm.commerce.tools.devtools.publish.tasks.StoreIdBaseDeployTaskCmd"/>
	<deploy-task-cmd name="fileFilter" class="com.ibm.commerce.tools.devtools.publish.tasks.unpack.FileFilterTaskCmd"/>
	
	<target id="all">
		<task name="copyATPFiles">
			<param name="toDir" value="${wc:StoresDataPath}/${asset:foreignKeys#STORE_DIR}/data" />
			<param name="fromDir" value="${wc:StoresDataPath}/${asset:foreignKeys#STORE_DIR}/data/${asset:foreignKeys#INV_CHOICE}/data/" />
		</task>
		<task name="copyLocaleFile">
			<param name="basename" value="${asset:profileorg}" />
		</task>
		<task name="idresolve">
			<param name="infile" value="${asset:master}" />
			<param name="outfile" value="${asset:resolved.master}" />
		</task>
		<task name="massload">
			<param name="infile" value="${asset:resolved.master}" />
			<param name="maxerror" value="1" />	
			<param name="noprimary" value="error" />
		</task>
		<task name="accountImport">
			<param name="tradingXMLFileName" value="${asset:account}" />
			<param name="XMLEntityPath" value="${config:Trading/DTDPath};${asset:.}" />
			<param name="storeIdentifier" value="${asset:foreignKeys#STORE_IDENTIFIER_RPS}" />
			<param name="organizationDN" value="${asset:foreignKeys#ORG_DN_PROFILE_PART}${asset:foreignKeys#ORGANIZATION_DN}" />
		</task>
		<task name="reconcileStoreLanguages">
			<param name="storeIdentifier" value="${asset:foreignKeys#STORE_IDENTIFIER_RPS}" />
			<param name="organizationDN" value="${asset:foreignKeys#ORG_DN_PROFILE_PART}${asset:foreignKeys#ORGANIZATION_DN}" />
		</task>
		<task name="findStore">
			<param name="storeIdentifier" value="${asset:foreignKeys#STORE_IDENTIFIER_RPS}" />
			<param name="organizationDN" value="${asset:foreignKeys#ORG_DN_PROFILE_PART}${asset:foreignKeys#ORGANIZATION_DN}" />
			<export name="storeEntityId" value="storeEntityId"/>
		</task>
		<task name="fileFilter">
			<param name="input-filename" value="${asset:b2b-strutsConfigUpdate.template}"/>
			<param name="output-filename" value="${asset:b2b-strutsConfigUpdate}"/>
			<param name="storeId" value="${context:storeEntityId}"/>
		</task>
		<task name="fileFilter">
			<param name="input-filename" value="${asset:strutsConfigUpdate.template}"/>
			<param name="output-filename" value="${asset:strutsConfigUpdate}"/>
			<param name="storeId" value="${context:storeEntityId}"/>
		</task>
		<task name="fileFilter">
			<param name="input-filename" value="${asset:strutsTileConfigUpdate.template}"/>
			<param name="output-filename" value="${asset:strutsTileConfigUpdate}"/>
			<param name="storeId" value="${context:storeEntityId}"/>
		</task>
		<task name="commandInvoker">
			<param name="invoked_commandClassName" value="com.ibm.commerce.struts.commands.UpdateStrutsConfigFileCmd"/>
			<param name="webAppName" value="Stores" />
			<param name="updateFileName" value="${asset:strutsConfigUpdate}"/>
			<param name="updateTileFileName" value="${asset:strutsTileConfigUpdate}"/>
		</task>
		<task name="commandInvoker">
			<param name="invoked_commandClassName" value="com.ibm.commerce.struts.commands.UpdateStrutsConfigFileCmd"/>
			<param name="webAppName" value="Stores" />
			<param name="updateFileName" value="${asset:b2b-strutsConfigUpdate}"/>
			<param name="updateTileFileName" value="${asset:strutsTileConfigUpdate}"/>
		</task>
		<task name="setupContentDirectory">
			<param name="storeDir" value="${asset:foreignKeys#STORE_DIR}" />
		</task>
		<task name="commandInvoker">
			<param name="invoked_commandClassName" value="com.ibm.commerce.scheduler.commands.RefreshRegistryCmd" />
			<param name="URL" value="/ignore" />
		</task>
	</target>
</data-deploy>
